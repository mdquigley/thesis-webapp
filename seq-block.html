<!DOCTYPE html>
<html lang="en">
<!-- test git change -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seq-Block</title>
    <link rel="stylesheet" href="style.css">
    <script src="node_modules/tone/build/Tone.js"></script>
    <script src="node_modules/@tonejs/ui/build/tone-ui.js"></script>
    <script src="node_modules/blockly/blockly_compressed.js"></script>
    <script src="node_modules/blockly/blocks_compressed.js"></script>
    <script src="node_modules/blockly/javascript_compressed.js"></script>
    <script src="node_modules/blockly/msg/en.js"></script>
    <script src="mq_blocks/mq_synth.js"></script>
    <script src="mq_blocks/mq_ampenv.js"></script>
    <script src="mq_blocks/mq_4step.js"></script>
    <script src="mq_blocks/mq_8step.js"></script>
    <script src="mq_blocks/mq_instrument.js"></script>
    <script src="mq_blocks/mq_chord.js"></script>
    <script src="mq_blocks/mq_sequence.js"></script>
    <script src="mq_blocks/mq_4stepToneloop.js"></script>
    <script src="mq_blocks/mq_8stepToneloop.js"></script>
    <script src="mq_blocks/mq_panvol.js"></script>

</head>

<body>
    <!-- <button type="button" id="start">Start</button> -->
    <!-- <button type="button" id="stop">Stop</button><br /> -->

    <div class="controls">
        <button type="button" id="run" data-on="false">Start</button><br />
        <label for="tempo">Tempo</label>
        <input type="range" name="tempo" id="tempo" min="20" max="400" value="120"><br />
        <div id="visualizer"></div>
    </div>

    <!-- create empty div for blockly -->
    <div id="blocklyDiv" style="height: 800px; width: 1000px;"></div>
    <!-- <xml id="toolbox" style="display: none" xmlns="https://developers.google.com/blockly/xml">
        <block type="mq_synth"></block>
        <block type="mq_step"></block>
        <block type="mq_instrument"></block>
        <block type="mq_chord"></block>
        <block type="mq_sequence"></block>
        <block type="mq_4step"></block>
        <block type="mq_8step"></block>
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
        <block type="logic_compare"></block>
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="text"></block>
        <block type="text_print"></block>
    </xml> -->

    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="Music" categorystyle="music_category">
            <block type="mq_synth"></block>
            <block type="mq_4stepToneloop">
                <value name="PITCH1">
                    <block type="math_number">
                        <field name="NUM">60</field>
                    </block>
                </value>
            </block>
            <block type="mq_8stepToneloop"></block>
            <block type="mq_ampenv"></block>
            <block type="mq_panvol">
                <value name="pan">
                    <block type="math_number">
                        <field name="NUM">1</field>
                    </block>
                </value>
            </block>
            <block type="mq_4step"></block>
            <block type="mq_8step"></block>
            <block type="mq_instrument"></block>
            <block type="mq_chord"></block>
            <block type="mq_sequence"></block>
        </category>
        <category name="Logic" categorystyle="logic_category">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_null" disabled="true"></block>
            <block type="logic_ternary"></block>
        </category>
        <category name="Loops" categorystyle="loop_category">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_repeat" disabled="true"></block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="Math" categorystyle="math_category">
            <block type="math_number" gap="32">
                <field name="NUM">60</field>
            </block>
            <block type="math_arithmetic">
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_single">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">9</field>
                    </shadow>
                </value>
            </block>
            <block type="math_trig">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">45</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constant"></block>
            <block type="math_number_property">
                <value name="NUMBER_TO_CHECK">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="math_round">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">3.1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_on_list"></block>
            <block type="math_modulo">
                <value name="DIVIDEND">
                    <shadow type="math_number">
                        <field name="NUM">64</field>
                    </shadow>
                </value>
                <value name="DIVISOR">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constrain">
                <value name="VALUE">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="LOW">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="HIGH">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_float"></block>
            <block type="math_atan2">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Text" categorystyle="text_category">
            <block type="text"></block>
            <block type="text_multiline"></block>
            <block type="text_join"></block>
            <block type="text_append">
                <value name="TEXT">
                    <shadow type="text"></shadow>
                </value>
            </block>
            <block type="text_length">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_isEmpty">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT"></field>
                    </shadow>
                </value>
            </block>
            <block type="text_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
                <value name="FIND">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_charAt">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
            </block>
            <block type="text_getSubstring">
                <value name="STRING">
                    <block type="variables_get">
                        <field name="VAR">text</field>
                    </block>
                </value>
            </block>
            <block type="text_changeCase">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_trim">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_count">
                <value name="SUB">
                    <shadow type="text"></shadow>
                </value>
                <value name="TEXT">
                    <shadow type="text"></shadow>
                </value>
            </block>
            <block type="text_replace">
                <value name="FROM">
                    <shadow type="text"></shadow>
                </value>
                <value name="TO">
                    <shadow type="text"></shadow>
                </value>
                <value name="TEXT">
                    <shadow type="text"></shadow>
                </value>
            </block>
            <block type="text_reverse">
                <value name="TEXT">
                    <shadow type="text"></shadow>
                </value>
            </block>
            <label text="Input/Output:" web-class="ioLabel"></label>
            <block type="text_print">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_prompt_ext">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Lists" categorystyle="list_category">
            <block type="lists_create_with">
                <mutation items="0"></mutation>
            </block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">5</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getIndex">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_setIndex">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getSublist">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_split">
                <value name="DELIM">
                    <shadow type="text">
                        <field name="TEXT">,</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_sort"></block>
            <block type="lists_reverse"></block>
        </category>
        <category name="Colour" categorystyle="colour_category">
            <block type="colour_picker"></block>
            <block type="colour_random"></block>
            <block type="colour_rgb">
                <value name="RED">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
                <value name="GREEN">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="BLUE">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="colour_blend">
                <value name="COLOUR1">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#ff0000</field>
                    </shadow>
                </value>
                <value name="COLOUR2">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#3333ff</field>
                    </shadow>
                </value>
                <value name="RATIO">
                    <shadow type="math_number">
                        <field name="NUM">0.5</field>
                    </shadow>
                </value>
            </block>
        </category>
        <sep></sep>
        <category name="Variables" categorystyle="variable_category" custom="VARIABLE"></category>
        <category name="Functions" categorystyle="procedure_category" custom="PROCEDURE"></category>
    </xml>


    <div id="textarea"></div>

    <script>
        const glob = 'GLOBAL VAIRABLE';
        // let synthList = [];


        // inject Blockly into workspace
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            theme: 'Dark'
        });

        // set tempo for transport and monitor for change
        const tempo = document.getElementById('tempo');
        tempo.addEventListener('change', () => {
            Tone.Transport.bpm.value = tempo.value;
        });

        // start on click, set initial tempo
        // const start = document.getElementById('start');
        // start.addEventListener('click', runCode);

        // stop on click
        // const stop = document.getElementById('stop');
        // stop.addEventListener('click', () => {
        //     Tone.Transport.stop();
        // });

        const run = document.getElementById('run');
        run.addEventListener('click', () => {
            if (run.dataset.on == 'false') {
                runCode();
                run.dataset.on = true;
                run.innerText = 'Stop';
            } else {
                Tone.Transport.stop();
                run.dataset.on = false;
                run.innerText = 'Start';
            }
        })

        // update textarea function
        function updateTextArea(event) {
            // convert workspace to text code
            let textCode = Blockly.JavaScript.workspaceToCode(workspace);
            //update textarea div with text code
            document.getElementById('textarea').innerText = textCode;
        }
        // add change listener to textarea, call update function
        workspace.addChangeListener(updateTextArea);

        const toneWaveform = new Tone.Waveform();
        const merge = new Tone.Merge().connect(toneWaveform);
        Tone.Destination.fan(merge);
        waveform({
            tone: toneWaveform,
            parent: document.querySelector("#visualizer")
        })

        // load piano samples 
        const piano = new Tone.Sampler({
            urls: {
                A0: "A0.mp3",
                C1: "C1.mp3",
                "D#1": "Ds1.mp3",
                "F#1": "Fs1.mp3",
                A1: "A1.mp3",
                C2: "C2.mp3",
                "D#2": "Ds2.mp3",
                "F#2": "Fs2.mp3",
                A2: "A2.mp3",
                C3: "C3.mp3",
                "D#3": "Ds3.mp3",
                "F#3": "Fs3.mp3",
                A3: "A3.mp3",
                C4: "C4.mp3",
                "D#4": "Ds4.mp3",
                "F#4": "Fs4.mp3",
                A4: "A4.mp3",
                C5: "C5.mp3",
                "D#5": "Ds5.mp3",
                "F#5": "Fs5.mp3",
                A5: "A5.mp3",
                C6: "C6.mp3",
                "D#6": "Ds6.mp3",
                "F#6": "Fs6.mp3",
                A6: "A6.mp3",
                C7: "C7.mp3",
                "D#7": "Ds7.mp3",
                "F#7": "Fs7.mp3",
                A7: "A7.mp3",
                C8: "C8.mp3"
            },
            release: 1,
            baseUrl: "salamander/",
            onload: () => {
                console.log('piano loaded');
            }
        }).toDestination();

        const casio = new Tone.Sampler({
            urls: {
                A1: "A1.mp3",
                A2: "A2.mp3",
                "A#1": "As1.mp3",
                B1: "B1.mp3",
                C2: "C2.mp3",
                "C#2": "Cs2.mp3",
                D2: "D2.mp3",
                "D#2": "Ds2.mp3",
                E2: "E2.mp3",
                F2: "F2.mp3",
                "F#2": "Fs2.mp3",
                G2: "G2.mp3",
                "G#1": "Gs1.mp3"

            },
            release: 1,
            baseUrl: "casio/",
            onload: () => {
                console.log('casio loaded');
            }
        }).toDestination();

        let sequences = {};
        // let sequencesProxy = new Proxy(sequences, {
        //     get: (o, property) => {
        //         return property in o ? JSON.stringify(o) : null;
        //     },
        //     set: (o, property, value) => {
        //         o[property] = value;
        //     }
        // });

        let synths = {};
        let ampenvs = {};
        let noteLengths = {};
        let subdivisions = {};
        let panvols = {};
        function updateInterval(seq, sub) {
            seq.interval = sub;
        }


        class SynthObj {
            constructor() {
                this.sequence = [];
                this.subdivision = '4n';
                this.maxCount = 4;
                this.currentCount = 0;
                this.type = 'sine';
                this.synth = new Tone.Synth().toDestination();
                this.updateOsc = () => {
                    this.synth.set({ oscillator: { type: this.type } });
                };
            }
        }

        let synthList = [];

        // let synth1 = new Synth();
        // synth1.sequence = [60, 64, 67, 71];
        // let loop = new Tone.Loop((time) => {
        //     synth1.synth.triggerAttackRelease(Tone.Frequency(synth1.sequence[synth1.currentCount], 'midi'), '8n', "+0.05");
        //     synth1.currentCount = (synth1.currentCount + 1) % synth1.maxCount;
        // }, '8n').start(0);



        // Generate JavaScript code and run it
        async function runCode() {

            await Tone.start();

            // prevent infinite loop
            window.LoopTrap = 1000;
            Blockly.JavaScript.INFINITE_LOOP_TRAP =
                'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

            // convert workspace to text code
            Blockly.JavaScript.addReservedWords('code');
            const code = Blockly.JavaScript.workspaceToCode(workspace);

            Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

            // test adding Tone synth trigger
            wrapCode = code + `Tone.Transport.bpm.value = tempo.value;
            Tone.Transport.start();
            `


            // evaluate code
            try {
                eval(wrapCode);
            } catch (e) {
                alert(e);
            }
        }

        // function readNote(note) {
        //     return (note ? Tone.Frequency(eval(note), "midi") : null);
        // }

    </script>


</body>

</html>